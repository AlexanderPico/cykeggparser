package org.cytoscape.keggparser.tuning;


import com.google.gson.Gson;
import org.cytoscape.keggparser.KEGGParserPlugin;
import org.cytoscape.keggparser.com.*;
import org.cytoscape.keggparser.dialogs.KeggPrefsDialog;
import org.cytoscape.keggparser.dialogs.KeggWebLoadFrame;
import org.cytoscape.keggparser.tuning.string.DBManager;
import org.cytoscape.keggparser.tuning.string.JsonInteractions;
import org.cytoscape.keggparser.tuning.string.JsonNode;
import org.cytoscape.keggparser.tuning.string.StringParser;
import org.cytoscape.keggparser.tuning.tse.EKEGGTuningProps;
import org.cytoscape.keggparser.tuning.tse.GeneExpXmlParser;
import org.cytoscape.keggparser.tuning.tse.TSEDataSet;
import org.cytoscape.model.CyEdge;
import org.cytoscape.model.CyNetwork;
import org.cytoscape.model.CyNode;
import org.cytoscape.model.CyRow;
import org.cytoscape.view.model.CyNetworkView;
import org.cytoscape.view.model.View;
import org.cytoscape.view.presentation.property.LineTypeVisualProperty;
import org.cytoscape.work.TaskMonitor;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.swing.*;
import java.io.File;
import java.util.*;

public class Tuner_ex {
    private CyNetwork network;
    private CyNetwork tunedNetwork;
    private Logger logger = LoggerFactory.getLogger(Tuner_ex.class);
    private String geneIdAttr;
    private String typeAttr;
    private ArrayList<String> typeAttrValues;
    private int threshold;
    private File xmlFile;
    private CyNetworkView tunedNetworkView;

    public TSEDataSet getDataSet() {
        return dataSet;
    }

    private TSEDataSet dataSet;

    public CyNetwork getTunedNetwork() {
        return tunedNetwork;
    }

    public Tuner_ex(CyNetwork network, String geneIdAttr,
                    String typeAttr, ArrayList<String> typeAttrValues, int threshold) {
        this.network = network;
        this.geneIdAttr = geneIdAttr;
        this.threshold = threshold;
        this.typeAttr = typeAttr;
        this.typeAttrValues = typeAttrValues;
        this.threshold = threshold;
    }

    public void setDataSet(TSEDataSet dataSet) {
        this.dataSet = dataSet;
    }

    public boolean tuneByTSE(String tissue, boolean generateNewNetwork, TaskMonitor taskMonitor, int threshold) {
        TuningReportGenerator.getInstance().appendLine("Expression file: " + xmlFile.getPath());
        TuningReportGenerator.getInstance().appendLine("Tissue: " + tissue);
        TuningReportGenerator.getInstance().appendLine("Expression threshold: " + threshold);

        if (dataSet == null)
            dataSet = loadExpressionDataSet(tissue);
        dataSet.setThreshold(this.threshold);
        taskMonitor.setProgress(50);
//        System.out.println("Tuning by " + tissue);
        TuningReportGenerator.getInstance().appendLine("\nRemoved nodes: ");
        ArrayList<CyNode> removedNodes = new ArrayList<CyNode>();

        String netTitle = network.getRow(network).get(CyNetwork.NAME, String.class) + "_" + tissue + "_" + this.threshold;
        if (generateNewNetwork) {
            tunedNetwork = NetworkManager.copyNetwork(network,
                    netTitle);

        } else {
            tunedNetwork = network;
            network.getRow(network).set(CyNetwork.NAME, netTitle);
        }


        taskMonitor.setProgress(70);
        HashMap<CyNode, CyNode> sourceDistNodeMap = NetworkManager.getSourceDestNodeMap();
        for (CyNode sourceNode : network.getNodeList()) {
            CyNode tunedNode = sourceDistNodeMap.get(sourceNode);
            if (!isNodePresent(tunedNode, dataSet, tunedNetwork)) {
                removedNodes.add(sourceNode);
                tunedNetwork.removeNodes(Collections.singletonList(sourceDistNodeMap.get(sourceNode)));
            } else {
                filterNode(tunedNode, sourceNode, dataSet, removedNodes, tunedNetwork);
            }
        }
//        if (!tunedNetwork.removeNodes(removedNodes))
//            TuningReportGenerator.getInstance().appendLine("Could not removee the nodes");
        if (!removedNodes.isEmpty()) {
            for (CyNode cyNode : removedNodes) {
                TuningReportGenerator.getInstance().appendLine(cyNode.getSUID() + ":\t" +
                        network.getDefaultNodeTable().getRow(cyNode.getSUID()).get(geneIdAttr, String.class));
            }
        }
        return true;
    }

    private void filterNode(CyNode tunedNode, CyNode sourceNode, TSEDataSet dataSet, ArrayList<CyNode> removedNodes, CyNetwork cyNetwork) {
        if (typeAttr != null && typeAttrValues.size() != 0)
            for (String typeValue : typeAttrValues)
                if (cyNetwork.getDefaultNodeTable().getRow(tunedNode.getSUID()).get(typeAttr, String.class).equals(typeValue)) {
                    String name = tunedNetwork.getDefaultNodeTable().getRow(tunedNode.getSUID()).
                            get(EKeggNodeAttrs.NAME.getAttrName(), String.class);
                    String filteredName = "", filteredIds = "";
                    if (name != null) {
                        StringTokenizer tokenizer = new StringTokenizer(name);
                        while (tokenizer.hasMoreTokens()) {
                            String token = tokenizer.nextToken();
                            String geneId = "";
                            for (int i = 0; i < token.length(); i++)
                                if (Character.isDigit(token.charAt(i)))
                                    geneId += token.charAt(i);
                            if (!geneId.equals("") && dataSet.isGeneExpressed(geneId)) {
                                filteredName += token + " ";
                                filteredIds += (filteredIds.length() == 0 ? "" : ",\t") + geneId;
                            }
                        }
                    }
                    if (filteredName.equals("")) {
                        removedNodes.add(sourceNode);
                    } else {
                        cyNetwork.getDefaultNodeTable().getRow(tunedNode.getSUID()).
                                set(EKeggNodeAttrs.NAME.getAttrName(), filteredName);
                        cyNetwork.getDefaultNodeTable().getRow(tunedNode.getSUID())
                                .set(EKeggNodeAttrs.EntrezIDs.getAttrName(), filteredIds);
                    }
                }
    }

    private boolean isNodePresent(CyNode node, TSEDataSet dataSet, CyNetwork cyNetwork) {
        CyRow cyRow = cyNetwork.getDefaultNodeTable().getRow(node.getSUID());
        String typeAttrValue = null, entrezIds = null;
        try {
            typeAttrValue = cyRow.get(typeAttr, String.class);
            entrezIds = cyRow.get(geneIdAttr, String.class);
        } catch (NullPointerException e) {
            LoggerFactory.getLogger(Tuner_ex.class).error(e.getMessage());
//            KEGGParserPlugin.getTuningLog().error("zkeer" + e.getMessage());
        }
        if (typeAttrValue != null) {
            if (typeAttr != null && typeAttrValues.size() != 0)
                for (String typeValue : typeAttrValues)
                    if (typeAttrValue.equals(typeValue)) {
                        if (entrezIds != null) {
                            StringTokenizer tokenizer = new StringTokenizer(entrezIds, "\t,; abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ");
                            while (tokenizer.hasMoreTokens())
                                if (dataSet.isGeneExpressed(tokenizer.nextToken()))
                                    return true;
                            return false;
                        }
                    }
            return true;
        }
        return false;

    }


    public TSEDataSet loadExpressionDataSet(String tissue) {
        TuningReportGenerator.getInstance().appendLine("Gene expression values for tissue " + tissue + " loaded.");
        dataSet = new TSEDataSet(tissue);
        String conflictMode = KEGGParserPlugin.getKeggProps().getProperty(EKEGGTuningProps.ConflictMode.getName());
        if (conflictMode != null)
            if (conflictMode.equals(KeggPrefsDialog.MEAN))
                dataSet.setMode(TSEDataSet.MEAN);
            else if (conflictMode.equals(KeggPrefsDialog.MAX))
                dataSet.setMode(TSEDataSet.MAX);
            else
                dataSet.setMode(TSEDataSet.MIN);
        TreeSet<String> geneIds = new TreeSet<String>();
        for (Object node : network.getNodeList()) {
            CyNode cyNode = (CyNode) node;
            String entrezIds = network.getDefaultNodeTable().getRow(cyNode.getSUID()).get(geneIdAttr, String.class);
            if (entrezIds != null && !entrezIds.equals("")) {
                StringTokenizer tokenizer = new StringTokenizer(entrezIds, "\"\t,; abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ");
                while (tokenizer.hasMoreTokens())
                    geneIds.add(tokenizer.nextToken());
            }
        }
        ArrayList<String> notFoundGenes = new ArrayList<String>();
        GeneExpXmlParser parser = new GeneExpXmlParser(xmlFile);
        for (String geneId : geneIds) {
            double exp = parser.getExpValue(geneId, tissue);
            if (!Double.isNaN(exp))
                dataSet.addExp(geneId, exp);
            else
                notFoundGenes.add(geneId);
        }
        if (!notFoundGenes.isEmpty()) {
            TuningReportGenerator.getInstance().appendLine("The following genes were not found in the expression data file. \n" +
                    "These will not be removed from the network: ");
            String genes = "{";
            for (String geneId : notFoundGenes) {
                genes += geneId + ", ";
            }
            genes = genes.substring(0, genes.lastIndexOf(", ")) + "}";
            TuningReportGenerator.getInstance().appendLine(genes);
        }
        if (dataSet.size() == 0)
            return null;
        return dataSet;
    }


    public boolean drillDownNetwork(CyNetwork network, String newTitle, int threshold,
                                    ArrayList<String> sources, TaskMonitor taskMonitor) {

        TuningReportGenerator.getInstance().appendLine("PPI confidence threshold: " + threshold);
        String sourceString = "";
        for (String source : sources) {
            sourceString += source + ",";
        }
        sourceString = sourceString.substring(0, sourceString.lastIndexOf(','));
        TuningReportGenerator.getInstance().appendLine("Database sources: " + sourceString);
        CyNetworkView networkView = null;
        Collection<CyNetworkView> networkViews = KEGGParserPlugin.networkViewManager.getNetworkViews(network);
        if (networkViews.iterator().hasNext())
            networkView = networkViews.iterator().next();

        tunedNetwork = KEGGParserPlugin.networkFactory.createNetwork();
        newTitle = newTitle.replace(network.getSUID().toString(), tunedNetwork.getSUID().toString());
        tunedNetwork.getRow(tunedNetwork).set(CyNetwork.NAME, newTitle);

        taskMonitor.setProgress(0.2);


        ArrayList<JsonNode> jsonNodesArray = new ArrayList<JsonNode>();
        TreeMap<Long, ArrayList<Long>> memberMap = new TreeMap<Long, ArrayList<Long>>();
        TreeMap<String, Long> uniqueIdNodeMap = new TreeMap<String, Long>();
        ArrayList<CyNode> singleNodes = new ArrayList<CyNode>();

        int maxId = retrieveMaxId(network);

        //Set columns
        NetworkManager.createColumns(network.getDefaultNetworkTable(), tunedNetwork.getDefaultNetworkTable());
        NetworkManager.createColumns(network.getDefaultNodeTable(), tunedNetwork.getDefaultNodeTable());
        NetworkManager.createColumns(network.getDefaultEdgeTable(), tunedNetwork.getDefaultEdgeTable());

        NetworkManager.copyNetworkAttributes(network, tunedNetwork);

        HashMap<CyNode, ArrayList<CyNode>> parentChildrenNodesMap = new HashMap<>();
        // Drill the nodes
        for (Object node : network.getNodeList()) {
            CyNode cyNode = (CyNode) node;
            CyRow row = network.getDefaultNodeTable().getRow(cyNode.getSUID());
            String type = row.get(EKeggNodeAttrs.TYPE.getAttrName(), String.class);
            String entrezIds = row.get(EKeggNodeAttrs.EntrezIDs.getAttrName(), String.class);
            String uniqueId = row.get(EKeggNodeAttrs.UNIQUEID.getAttrName(), String.class);
            if (type != null && type.equals(KeggNode.GENE)) {
                JsonNode jsonNode = new JsonNode(cyNode.getSUID().toString());
                ArrayList<Long> membersList = new ArrayList<Long>();
                ArrayList<String> entrezIdlist = new ArrayList<String>();
                StringTokenizer tokenizer = new StringTokenizer(entrezIds, "\t,; abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ");
                while (tokenizer.hasMoreTokens())
                    entrezIdlist.add(tokenizer.nextToken());
                if (entrezIdlist.isEmpty())
                    System.out.println("Node " + cyNode.getSUID() + " does not have entrez ids");
                else {
                    for (String entrezId : entrezIdlist) {
                        if (!uniqueIdNodeMap.containsKey(entrezId)) {
                            row = network.getDefaultNodeTable().getRow(cyNode.getSUID());
                            addDrilledNode(cyNode, row, entrezId, uniqueIdNodeMap, parentChildrenNodesMap, true, maxId);
                        }
                        try {
                            int geneId = Integer.parseInt(entrezId);
                            jsonNode.addGeneId(geneId + "");
                            membersList.add(uniqueIdNodeMap.get(entrezId));
                        } catch (NumberFormatException e) {
//                            LoggerFactory.getLogger(Tuner.class).error(e.getMessage());
                        }
                    }
                    memberMap.put(cyNode.getSUID(), membersList);
                    jsonNodesArray.add(jsonNode);
                }
            } else {
                if (uniqueId == null || !uniqueId.equals("")) {
                    String name = row.get(EKeggNodeAttrs.NAME.getAttrName(), String.class);
                    if (name != null)
                        uniqueId = name;
                    else
                        uniqueId = "arsen_" + cyNode.getSUID().toString();
                }
                if (!uniqueIdNodeMap.containsKey(uniqueId)) {
                    addDrilledNode(cyNode, row, uniqueId, uniqueIdNodeMap, parentChildrenNodesMap, false, maxId);
                }
            }

        }
        taskMonitor.setStatusMessage("Retrieving interactions from the database...");
        //Set interactions
        Gson gson = new Gson();
        String jsonString = gson.toJson(jsonNodesArray);
        if (jsonString == null || jsonString.isEmpty()) {
            TuningReportGenerator.getInstance().appendLine("Problems generating json");
            LoggerFactory.getLogger(Tuner_ex.class).error("Problems generating json");
            return false;
        }
        String org = network.getDefaultNetworkTable().getRow(network.getSUID())
                .get(EKGMLNetworkAttrs.ORGANISM.getAttrName(), String.class);

        Map<String, Map<String,
                ArrayList<JsonInteractions.InteractionParams>>> interactions = null;
        try {
            if (org == null)
                org = askFromUserAboutOrganism();
            if (org != null && !org.isEmpty())
                interactions = DBManager.getInteractionsMap(jsonString, threshold, org, sourceString);
            else {
                taskMonitor.setStatusMessage("No organisms were specified, " +
                        "therefore data retrieval will take long (usually 1 min), please be patient :)");
                interactions = DBManager.getInteractionsMap(jsonString, threshold, sourceString);
            }
        } catch (Exception e) {
            e.printStackTrace();
        }

        if (interactions == null || interactions.isEmpty()) {
            LoggerFactory.getLogger(Tuner_ex.class).warn("No interactions retrieved for the json " + jsonString);
            TuningReportGenerator.getInstance().appendLine("No interactions were retrieved for the network.\nCancelled tuning.");
            JOptionPane.showMessageDialog(KEGGParserPlugin.cytoscapeDesktopService.getJFrame(),
                    "No interactions were retrieved for the network! Exiting.");
            return false;
        } else {
            TuningReportGenerator.getInstance().appendLine("Interactions successfully retrieved from String database. ");
            taskMonitor.setProgress(0.8);
            taskMonitor.setStatusMessage("Interactions successfully retrieved");

            //Set interactions
            ArrayList<CyNode> connectedNodes = new ArrayList<CyNode>();
            for (Object edge : network.getEdgeList()) {
                CyEdge cyEdge = (CyEdge) edge;
                CyNode source = cyEdge.getSource();
                CyNode target = cyEdge.getTarget();
                ArrayList<CyNode> sourceNodes = null;
                ArrayList<CyNode> targetNodes = null;
                if (memberMap.containsKey(source.getSUID())) {
                    if (memberMap.get(source.getSUID()) != null) {
                        sourceNodes = new ArrayList<CyNode>();
                        for (Long memberID : memberMap.get(source.getSUID()))
                            sourceNodes.add(tunedNetwork.getNode(memberID));
                    } else
                        sourceNodes = null;
                } else
                    sourceNodes = null;

                if (memberMap.containsKey(target.getSUID())) {
                    if (memberMap.get(target.getSUID()) != null) {
                        targetNodes = new ArrayList<CyNode>();
                        for (Long memberID : memberMap.get(target.getSUID()))
                            targetNodes.add(tunedNetwork.getNode(memberID));
                    } else
                        targetNodes = null;
                } else
                    targetNodes = null;
                if (sourceNodes != null && !sourceNodes.isEmpty() &&
                        targetNodes != null && !targetNodes.isEmpty()) {
                    for (CyNode sourceNode : sourceNodes)
                        for (CyNode targetNode : targetNodes) {
                            try {
                                int source_id = Integer.parseInt(tunedNetwork.getDefaultNodeTable().getRow(sourceNode.getSUID()).
                                        get(EKeggNodeAttrs.ENTREZ_ID.getAttrName(), String.class));
                                int target_id = Integer.parseInt(tunedNetwork.getDefaultNodeTable().getRow(targetNode.getSUID()).
                                        get(EKeggNodeAttrs.ENTREZ_ID.getAttrName(), String.class));
                                String sourceEntrezID = source_id + "";
                                String targetEntrezID = target_id + "";
                                if (interactionExists(sourceEntrezID, targetEntrezID, interactions))
                                    if (!tunedNetwork.containsEdge(sourceNode, targetNode)) {
                                        setMemberEdge(sourceNode, targetNode, cyEdge, tunedNetwork);
                                        connectedNodes.add(sourceNode);
                                        connectedNodes.add(targetNode);
                                    }
                            } catch (NumberFormatException e) {
//                                LoggerFactory.getLogger(Tuner.class).error(e.getMessage());
                            }
                        }
                } else if (sourceNodes != null && !sourceNodes.isEmpty()) {
                    Long id;
                    String unique_id = network.getDefaultNodeTable().getRow(target.getSUID()).
                            get(EKeggNodeAttrs.UNIQUEID.getAttrName(), String.class);
                    if (unique_id == null || unique_id.equals(""))
                        unique_id = network.getDefaultNodeTable().getRow(target.getSUID()).
                                get(EKeggNodeAttrs.NAME.getAttrName(), String.class);
                    if (unique_id == null || unique_id.equals("") || !uniqueIdNodeMap.containsKey(unique_id)) {
                        id = target.getSUID();
                    } else {
                        id = uniqueIdNodeMap.get(unique_id);
                    }
                    CyNode targetNode = tunedNetwork.getNode(id);
                    if (targetNode != null) {
                        for (CyNode sourceNode : sourceNodes) {
                            if (!tunedNetwork.containsEdge(sourceNode, targetNode)) {
                                setMemberEdge(sourceNode, targetNode, cyEdge, tunedNetwork);
                                connectedNodes.add(sourceNode);
                                connectedNodes.add(targetNode);
                            }
                        }
                    } else
                        System.out.println("target " + target.getSUID().toString() + " resulted in null node ");

                } else if (targetNodes != null && !targetNodes.isEmpty()) {
                    Long id;
                    String unique_id = network.getDefaultNodeTable().getRow(source.getSUID()).
                            get(EKeggNodeAttrs.UNIQUEID.getAttrName(), String.class);
                    if (unique_id == null || unique_id.equals(""))
                        unique_id = network.getDefaultNodeTable().getRow(source.getSUID()).
                                get(EKeggNodeAttrs.NAME.getAttrName(), String.class);
                    if (unique_id == null || unique_id.equals("") || !uniqueIdNodeMap.containsKey(unique_id)) {
                        id = source.getSUID();
                    } else {
                        id = uniqueIdNodeMap.get(unique_id);
                    }
                    CyNode sourceNode = null;
                    try {
                        sourceNode = tunedNetwork.getNode(id);
                    } catch (Exception e) {
                        e.printStackTrace();
                    }
                    if (sourceNode != null) {
                        for (CyNode targetNode : targetNodes) {
                            if (!tunedNetwork.containsEdge(sourceNode, targetNode)) {
                                setMemberEdge(sourceNode, targetNode, cyEdge, tunedNetwork);
                                connectedNodes.add(sourceNode);
                                connectedNodes.add(targetNode);
                            }
                        }
                    } else {
                        System.out.println("source " + source.getSUID().toString() + " resulted in null node ");
                    }
                } else {
                    Long id;
                    String unique_id = network.getDefaultNodeTable().getRow(target.getSUID()).
                            get(EKeggNodeAttrs.UNIQUEID.getAttrName(), String.class);
                    if (unique_id == null || unique_id.equals(""))
                        unique_id = network.getDefaultNodeTable().getRow(target.getSUID()).
                                get(EKeggNodeAttrs.NAME.getAttrName(), String.class);
                    if (unique_id == null || unique_id.equals("") || !uniqueIdNodeMap.containsKey(unique_id)) {
                        id = target.getSUID();
                    } else {
                        id = uniqueIdNodeMap.get(unique_id);
                    }
                    CyNode targetNode = null;
                    try {
                        targetNode = tunedNetwork.getNode(id);
                    } catch (Exception e) {
                        e.printStackTrace();
                    }

                    unique_id = network.getDefaultNodeTable().getRow(source.getSUID()).
                            get(EKeggNodeAttrs.UNIQUEID.getAttrName(), String.class);
                    if (unique_id == null || unique_id.equals(""))
                        unique_id = network.getDefaultNodeTable().getRow(source.getSUID()).
                                get(EKeggNodeAttrs.NAME.getAttrName(), String.class);
                    if (unique_id == null || unique_id.equals("") || !uniqueIdNodeMap.containsKey(unique_id)) {
                        id = source.getSUID();
                    } else {
                        id = uniqueIdNodeMap.get(unique_id);
                    }

                    CyNode sourceNode = tunedNetwork.getNode(id);
                    if (sourceNode == null)
                        System.out.println("source " + source.getSUID().toString() + " resulted in null node ");
                    else if (targetNode == null)
                        System.out.println("target " + source.getSUID().toString() + " resulted in null node ");
                    else {
                        if (!tunedNetwork.containsEdge(sourceNode, targetNode)) {
                            setMemberEdge(sourceNode, targetNode, cyEdge, tunedNetwork);
                            connectedNodes.add(sourceNode);
                            connectedNodes.add(targetNode);
                        }
                    }
//                    System.out.println("No interactions set for " + cyEdge.getIdentifier());
                }
            }
            taskMonitor.setProgress(0.9);
            ArrayList<CyNode> singleNodeList = new ArrayList<>();
            for (Object node : tunedNetwork.getNodeList()) {
                CyNode cyNode = (CyNode) node;
                if (!connectedNodes.contains(cyNode)) {
                    singleNodes.add(cyNode);
                }
            }
            tunedNetwork.removeNodes(singleNodes);
            if (!singleNodes.isEmpty()) {

                String singleNodeEntryIds = "{";
                for (CyNode cyNode : singleNodes) {
                    singleNodeEntryIds += cyNode.getSUID().toString() + ", ";
                }
                singleNodeEntryIds = singleNodeEntryIds.substring(0, singleNodeEntryIds.lastIndexOf(", "));
                singleNodeEntryIds += "}";
                TuningReportGenerator.getInstance().appendLine("Removed disconnected node entry IDs: " + singleNodeEntryIds);
            }
        }


        TuningReportGenerator.getInstance().appendLine("Finished the drill down.");
        TuningReportGenerator.getInstance().appendLine("Resulted network title: " + tunedNetwork.getRow(tunedNetwork).get("Name", String.class));
        TuningReportGenerator.getInstance().appendLine("Number of nodes: " + tunedNetwork.getNodeList().size());
        TuningReportGenerator.getInstance().appendLine("Number of edges: " + tunedNetwork.getEdgeList().size());
        TuningReportGenerator.getInstance().appendLine("Number of disconnected nodes removed from the network: " + singleNodes.size());

        KEGGParserPlugin.networkManager.addNetwork(tunedNetwork);
        tunedNetworkView = KEGGParserPlugin.networkViewFactory.createNetworkView(tunedNetwork);
        KEGGParserPlugin.networkViewManager.addNetworkView(tunedNetworkView);
        for (CyNode cyNode : network.getNodeList()) {
            View<CyNode> nodeView = networkView.getNodeView(cyNode);
            if (parentChildrenNodesMap.containsKey(cyNode))
                for (CyNode childNode : parentChildrenNodesMap.get(cyNode)) {
                    View<CyNode> childNodeView = tunedNetworkView.getNodeView(childNode);
                    NetworkManager.copyNodeCoordinates(nodeView, childNodeView);
                }
        }
        return true;
    }

    private String askFromUserAboutOrganism() {
        String org = null;
        try {
            String[] orgValues, lines, tokens;
            String url = "http://rest.kegg.jp/list/organism";
            String result = KeggWebLoadFrame.sendRestRequest(url).toString();
            lines = result.split("\n");
            orgValues = new String[lines.length];
            for (int i = 0; i < orgValues.length; i++) {
                tokens = lines[i].split("\t");
                orgValues[i] = tokens[1];
            }

            org = (String) JOptionPane.showInputDialog(KEGGParserPlugin.cytoscapeDesktopService.getJFrame(),
                    "Organism specification",
                    "Please, specify the organism to speed up PPI data retrieval",
                    JOptionPane.QUESTION_MESSAGE,
                    null, orgValues, "hsa");
        } catch (Exception e) {
            LoggerFactory.getLogger(Tuner_ex.class).warn(e.getMessage());
        }
        return org;
    }

    private void addDrilledNode(CyNode parentNode, CyRow row, String uniqueId,
                                TreeMap<String, Long> uniqueIdNodeMap,
                                HashMap<CyNode, ArrayList<CyNode>> parentChildrenNodesMap,
                                boolean isGene, int maxId) {
        String parentId = row.get(EKeggNodeAttrs.ENTRY_ID.getAttrName(), String.class);
        CyNode geneNode = tunedNetwork.addNode();
        if (parentChildrenNodesMap.containsKey(parentNode)) {
            parentChildrenNodesMap.get(parentNode).add(geneNode);
        } else {
            ArrayList<CyNode> childrenList = new ArrayList<>();
            childrenList.add(geneNode);
            parentChildrenNodesMap.put(parentNode, childrenList);
        }

        if (!uniqueId.equals(""))
            uniqueIdNodeMap.put(uniqueId, geneNode.getSUID());

        CyRow tunedRow = tunedNetwork.getDefaultNodeTable().getRow(geneNode.getSUID());

        NetworkManager.copyNodeAttributes(parentNode, geneNode, network, tunedNetwork);
        NetworkManager.setAttribute(EKeggNodeAttrs.LABEL.getAttrName(), uniqueId, tunedRow, tunedNetwork);
        NetworkManager.setAttribute(EKeggNodeAttrs.PARENT_ENTRY_ID.getAttrName(), parentId, tunedRow, tunedNetwork);
        if (!isGene)
            NetworkManager.setAttribute(EKeggNodeAttrs.ENTRY_ID.getAttrName(), parentId, tunedRow, tunedNetwork);
        if (isGene) {
            NetworkManager.setAttribute(EKeggNodeAttrs.ENTREZ_ID.getAttrName(), uniqueId, row, tunedNetwork);
            NetworkManager.setAttribute(EKeggNodeAttrs.ENTRY_ID.getAttrName(), maxId + "", row, tunedNetwork);
            NetworkManager.setAttribute(EKeggNodeAttrs.NAME.getAttrName(), "hsa:" + uniqueId, row, tunedNetwork);
        }
    }


    private void setMemberEdge(CyNode sourceNode, CyNode targetNode, CyEdge cyEdge, CyNetwork newNetwork) {
        CyEdge memberEdge = tunedNetwork.addEdge(sourceNode, targetNode, true);
        NetworkManager.copyEdgeAttributes(cyEdge, memberEdge, network, tunedNetwork);
        NetworkManager.setAttribute(EKeggEdgeAttrs.ENTRY1.getAttrName(),
                tunedNetwork.getDefaultNodeTable().getRow(sourceNode.getSUID()).
                        get(EKeggNodeAttrs.ENTRY_ID.getAttrName(), String.class),
                tunedNetwork.getDefaultEdgeTable().getRow(memberEdge.getSUID()),
                tunedNetwork);
        NetworkManager.setAttribute(EKeggEdgeAttrs.ENTRY2.getAttrName(),
                tunedNetwork.getDefaultNodeTable().getRow(targetNode.getSUID()).
                        get(EKeggNodeAttrs.ENTRY_ID.getAttrName(), String.class),
                tunedNetwork.getDefaultEdgeTable().getRow(memberEdge.getSUID()),
                tunedNetwork);
    }

    private boolean interactionExists(String sourceEntrezID, String targetEntrezID,
                                      Map<String, Map<String,
                                              ArrayList<JsonInteractions.InteractionParams>>> interactions) {
        if (sourceEntrezID == null || targetEntrezID == null || interactions == null)
            return false;
        Map<String, ArrayList<JsonInteractions.InteractionParams>> interactors;

        if ((interactors = interactions.get(sourceEntrezID)) != null)
            if (interactors.get(targetEntrezID) != null)
                return true;
        return false;
    }

    private int retrieveMaxId(CyNetwork network) {
        int maxId = 0;
        for (Object node : network.getNodeList()) {
            CyNode cyNode = (CyNode) node;

            String entryId = network.getDefaultNodeTable().getRow(cyNode.getSUID()).
                    get(EKeggNodeAttrs.ENTRY_ID.getAttrName(), String.class);
            if (entryId != null && !entryId.equals("")) {
                int id = 0;
                try {
                    id = Integer.parseInt(entryId);
                } catch (Exception e) {
//                    LoggerFactory.getLogger(Tuner.class).error(e.getMessage());
                }

                if (id > maxId)
                    maxId = id;
            }
        }
        return maxId;
    }

    public void tuneByPPI(ArrayList<String> sources, boolean generateNewNetwork,
                          TaskMonitor taskMonitor) {

        taskMonitor.setProgress(50);

        logger.debug("Tuning by " + sources.toArray().toString());
        logger.debug("Removed nodes: \n");
        System.out.println("Tuning by " + sources.toArray().toString());
        System.out.println("Removed nodes: \n");
        StringParser parser = StringParser.getParser();

        if (!sources.isEmpty()) {
            String netTitle = network.getRow(network).get(CyNetwork.NAME, String.class) + "_";
            for (String source : sources)
                netTitle += (source.charAt(0) + "").toUpperCase();
            netTitle += threshold;
            if (generateNewNetwork) {
                tunedNetwork = NetworkManager.copyNetwork(network,
                        netTitle);
            } else {
                tunedNetwork = network;
                network.getRow(network).set(CyNetwork.NAME, netTitle);
            }

            taskMonitor.setProgress(30);

            ArrayList<CyEdge> removedEdges = new ArrayList<>();
            for (Object edge : tunedNetwork.getEdgeList()) {
                CyEdge cyEdge = (CyEdge) edge;
                CyNode source = cyEdge.getSource();
                CyNode target = cyEdge.getTarget();
                System.out.print(cyEdge.getSUID().toString() + ":\n");
//                System.out.println("\tSource: " +
//                        nodeAttrs.getAttribute(source.getIdentifier(), geneIdAttr));
//                System.out.println("\tTarget: " +
//                        nodeAttrs.getAttribute(target.getIdentifier(), geneIdAttr));
                if (tunedNetwork.getDefaultNodeTable().getRow(source.getSUID()).
                        get(EKeggNodeAttrs.TYPE.getAttrName(), String.class).
                        equals(KeggNode.GENE)) {
                    if (tunedNetwork.getDefaultNodeTable().getRow(target.getSUID()).
                            get(EKeggNodeAttrs.TYPE.getAttrName(), String.class).
                            equals(KeggNode.GENE))
                        if (tunedNetwork.getDefaultEdgeTable().getRow(cyEdge).
                                get(EKeggEdgeAttrs.LINESTYLE.getAttrName(), String.class).
                                equals(LineTypeVisualProperty.SOLID.getDisplayName()))
                            if (!isEdgePresent(source, target, sources, parser)) {
                                removedEdges.add(cyEdge);
                                logger.debug(cyEdge.getSUID().toString() + ":\n");
                                logger.debug("\tSource: " + tunedNetwork.getDefaultNodeTable().getRow(source.getSUID())
                                        .get(geneIdAttr, String.class) + "\n");
                                logger.debug("\tTarget: " + tunedNetwork.getDefaultNodeTable().getRow(target.getSUID())
                                        .get(geneIdAttr, String.class) + "\n");
                                System.out.println(cyEdge.getSUID().toString() + " deleted\n*****************************");
                            }
                } else
                    System.out.println(cyEdge.getSUID().toString() + " kept\n*****************************");

            }
            tunedNetwork.removeEdges(removedEdges);
        } else {
            System.out.println("No sources chosen for PPI tuning");
        }
    }

    private boolean isEdgePresent(CyNode source, CyNode target, ArrayList<String> sources,
                                  StringParser parser) {
        if (typeAttr != null && typeAttrValues.size() != 0)
            for (String typeValue : typeAttrValues)
                if (tunedNetwork.getDefaultNodeTable().getRow(source.getSUID())
                        .get(typeAttr, String.class).equals(typeValue))
                    if (tunedNetwork.getDefaultNodeTable().getRow(target.getSUID())
                            .get(typeAttr, String.class).equals(typeValue)) {
                        String sEntrezIds = tunedNetwork.getDefaultNodeTable().getRow(source.getSUID())
                                .get(geneIdAttr, String.class);
                        String tEntrezIds = tunedNetwork.getDefaultNodeTable().getRow(target.getSUID())
                                .get(geneIdAttr, String.class);
                        if (sEntrezIds != null && tEntrezIds != null) {
                            StringTokenizer sTokenizer = new StringTokenizer(sEntrezIds,
                                    "\t,; abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ");
                            StringTokenizer tTokenizer;

//                            if (sTokenizer.countTokens() == 0)
//                                System.out.println("No entrezIds for node " + source.getIdentifier());
//                            if (tTokenizer.countTokens() == 0)
//                                System.out.println("No entrezIds for node " + target.getIdentifier());
                            double maxScore = 0;
                            while (sTokenizer.hasMoreTokens()) {
                                String sourceId = sTokenizer.nextToken();
                                tTokenizer = new StringTokenizer(tEntrezIds,
                                        "\t,; abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ");
                                while (tTokenizer.hasMoreTokens()) {
                                    String targetId = tTokenizer.nextToken();
                                    double score = parser.getScore(sourceId,
                                            targetId, sources);
                                    System.out.println(sourceId + " - " + targetId + ": " + score);
                                    if (score > maxScore)
                                        maxScore = score;
                                }
                            }
                            return maxScore > threshold;
                        }
                    }
        return false;
    }

    public void setXmlFile(File xmlFile) {
        this.xmlFile = xmlFile;
    }
}
